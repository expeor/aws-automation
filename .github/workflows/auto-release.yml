name: Auto Release

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type (auto, patch, minor, major)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  analyze:
    name: Analyze Commits
    # Skip release commits to prevent infinite loops
    if: "!contains(github.event.head_commit.message, 'chore: bump version')"
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.analyze.outputs.should_release }}
      new_version: ${{ steps.analyze.outputs.new_version }}
      version_type: ${{ steps.analyze.outputs.version_type }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Analyze commits
        id: analyze
        run: |
          if [ "${{ github.event.inputs.version_type }}" != "" ] && [ "${{ github.event.inputs.version_type }}" != "auto" ]; then
            # Manual version type override
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            CURRENT_VERSION=$(cat version.txt)

            # Calculate new version
            IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
            case "$VERSION_TYPE" in
              major) NEW_VERSION="$((major + 1)).0.0" ;;
              minor) NEW_VERSION="${major}.$((minor + 1)).0" ;;
              patch) NEW_VERSION="${major}.${minor}.$((patch + 1))" ;;
            esac

            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
            echo "version_type=$VERSION_TYPE" >> "$GITHUB_OUTPUT"
          else
            # Automatic analysis
            python .github/scripts/release.py analyze
          fi

      - name: Summary
        run: |
          echo "### Release Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Should Release**: ${{ steps.analyze.outputs.should_release }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Type**: ${{ steps.analyze.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version**: ${{ steps.analyze.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY

  create-release-pr:
    name: Create Release PR
    needs: [analyze]
    if: needs.analyze.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update version files
        run: python .github/scripts/release.py update

      - name: Create release branch
        id: branch
        run: |
          VERSION="${{ needs.analyze.outputs.new_version }}"
          BRANCH="release/v${VERSION}"
          git checkout -b "$BRANCH"
          git add version.txt CHANGELOG.md
          git commit -m "chore: bump version to ${VERSION}"
          git push -u origin "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create PR
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.analyze.outputs.new_version }}"
          VERSION_TYPE="${{ needs.analyze.outputs.version_type }}"

          PR_URL=$(gh pr create \
            --title "chore: release v${VERSION}" \
            --body "$(cat <<EOF
          ## Release v${VERSION}

          This is an automated release PR.

          ### Version Bump
          - **Type**: ${VERSION_TYPE}
          - **New Version**: ${VERSION}

          ### Changes
          See CHANGELOG.md for details.

          ---
          *This PR was auto-generated by the release workflow.*
          EOF
          )" \
            --base master \
            --head "${{ steps.branch.outputs.branch }}")

          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pr_number }} --auto --squash

      - name: Summary
        run: |
          echo "### Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ steps.create-pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ steps.branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-merge**: Enabled" >> $GITHUB_STEP_SUMMARY

  # This job runs when a release PR is merged
  # Triggered when commit message contains version bump indicator
  create-tag:
    name: Create Tag
    # Run when this is a release commit (analyze job was skipped)
    if: |
      always() &&
      (contains(github.event.head_commit.message, 'chore: bump version') ||
       contains(github.event.head_commit.message, 'chore: release'))
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: echo "version=$(cat version.txt)" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists
        id: check
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push tag
        if: steps.check.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Summary
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "### Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The publish workflow will now be triggered." >> $GITHUB_STEP_SUMMARY
