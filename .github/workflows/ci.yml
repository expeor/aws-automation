name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions following principle of least privilege
permissions:
  contents: read
  pull-requests: write  # Required for PR coverage comments
  security-events: write  # Required for SARIF upload to GitHub Security

jobs:
  # =============================================================================
  # PR Title Validation (Conventional Commits)
  # =============================================================================
  pr-title:
    name: PR Title
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            refactor
            docs
            test
            chore
            ci
            perf
            style
          requireScope: false

  # =============================================================================
  # Linting
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install ruff
        run: uv pip install --system ruff

      - name: Run ruff check
        run: ruff check core functions

      - name: Run ruff format check
        run: ruff format --check core functions

  # =============================================================================
  # Type Checking
  # =============================================================================
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt
          uv pip install --system mypy types-requests types-python-dateutil

      - name: Run MyPy
        run: mypy core functions --ignore-missing-imports

  # =============================================================================
  # Unit Tests (Multi-Python, Cross-Platform)
  # =============================================================================
  test:
    name: Test (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          # Windows/macOS는 최신 Python만 테스트 (비용 절감)
          - os: windows-latest
            python-version: "3.10"
          - os: windows-latest
            python-version: "3.11"
          - os: macos-latest
            python-version: "3.10"
          - os: macos-latest
            python-version: "3.11"
        include:
          - os: ubuntu-latest
            python-version: "3.14"
            experimental: true

    continue-on-error: ${{ matrix.experimental || false }}
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt
          uv pip install --system pytest pytest-cov pytest-timeout moto

      - name: Run tests with coverage
        run: |
          pytest tests/ --timeout=120 --cov=core --cov=functions --cov-branch --cov-report=xml --cov-report=term-missing --cov-fail-under=25 -v
        # NOTE: 커버리지 목표치 (현재 26%, 목표 50%+)
        # 테스트 추가 후 점진적으로 상향 조정 (20 → 25 → 30)

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: PR Coverage Comment
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: orgoro/coverage@v3.2
        with:
          coverageFile: coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Build Test (Verify package builds correctly)
  # =============================================================================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install build tools
        run: uv pip install --system build twine

      - name: Build package
        run: python -m build

      - name: Verify package with twine
        run: twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/
          retention-days: 7

  # =============================================================================
  # Security Scan (Optional but recommended)
  # =============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install security tools
        run: uv pip install --system pip-audit "bandit[sarif]"

      - name: Check dependencies for vulnerabilities
        run: pip-audit -r requirements.txt --desc on
        continue-on-error: true  # Advisory: doesn't block PR merge

      - name: Run Bandit security linter
        run: bandit -r core functions -ll --skip B101,B105,B311,B404,B603,B606,B607,B608
        # B101: assert usage (normal in tests)
        # B105: hardcoded password false positives
        # B311: random usage (not for security)
        # B404/B603/B606/B607: subprocess for file/browser opening (secure)
        # B608: DuckDB queries with internal AWS data

      - name: Run Bandit with SARIF output
        run: bandit -r core functions -f sarif -o bandit.sarif --skip B101,B105,B311,B404,B603,B606,B607,B608
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit.sarif
          category: bandit
